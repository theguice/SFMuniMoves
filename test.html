<!DOCTYPE html>
<meta charset="utf-8">
<head>
	<style>

	/* CSS goes here. */
	body {
		margin: 0;
	}
	</style>

	<script src="lib/jquery-1.11.1.min.js"></script>
	<script src="lib/jquery.xml2json.js"></script>
	<script src="lib/d3/d3.min.js"></script>
	<script src="lib/moment.js"></script>
	<script>

	$(document).ready(function() {

		var w = $(window).width(),
		    h = $(window).height(),
		    routes = {},
		    city = {
		    	lon: 122.4417686,
		    	lat: 37.7682044
		    };

		var projection = d3.geo.albers() 
		      .translate([w*3/8, h/2]) 
		      .scale(270000) 
		      .rotate([city.lon, 0]) 
		      .center([0, city.lat]); 

		var path = d3.geo.path().projection(projection);

		var zoom = d3.behavior.zoom()
			.translate(projection.translate())
			.scale(projection.scale())
			.scaleExtent([270000,4000000])
			.on("zoom", function() {
				projection.translate(d3.event.translate).scale(d3.event.scale);
				svg.selectAll(".svg_nbhd").attr("d", path);
				svg.selectAll("circle.vehicle").attr("cx", function(d) {
				    return projection([d.lon, d.lat])[0];
				});
				svg.selectAll("circle.vehicle").attr("cy", function(d) {
				    return projection([d.lon, d.lat])[1];
				});

		});



		var svg = d3.select("#map").insert("svg").attr("width", w*3/4).attr("height", h);
		svg.call(zoom);



		// test setup
		routes['sf-muni'] = {};
		routes['sf-muni']['routes'] = {};
		routes['sf-muni']['routes']['23'] = {};
		routes['sf-muni']['routes']['23']['last_time'] = 0;
		routes['sf-muni']['routes']['23']['poll'] = true;


		pollVehicles();
		setInterval(refreshDisplay, 2000);
		setInterval(pollVehicles, 15000);

		function refreshDisplay() {
			console.log(routes);
			displayVehiclesForRoute('sf-muni', '23');
		}

		function pollVehicles() {
			pollVehicleLocationsForRoute('sf-muni', '23');
		}

		function pollVehicleLocationsForRoute(agency_tag, route_tag) {
			console.log("polling route ", route_tag);

			var queryString = "http://webservices.nextbus.com/service/publicXMLFeed?command=vehicleLocations&a=" + agency_tag + "&r=" + route_tag + "&t=" + routes[agency_tag]['routes'][route_tag]['last_time'];

			d3.xml(queryString, function(xml) {
				json = $.xml2json(xml);

				// update last_time to the one in this response
				routes[agency_tag]['routes'][route_tag]['last_time'] = json['lastTime']['time'];

				// merge any previous vehicles with batch. Match by vehicle id key
				var vehicles;
				if (typeof routes[agency_tag]['routes'][route_tag]['vehicles'] == 'undefined') {
					routes[agency_tag]['routes'][route_tag]['vehicles'] = [];
				}
				vehicles = routes[agency_tag]['routes'][route_tag]['vehicles'];

				if (typeof json.vehicle !== 'undefined') {
					for (var i=0; i<json.vehicle.length; i++) {
						var isnew = true;
						for (var j=0; j<vehicles.length; j++) {
							// update any matches
							if (vehicles[j]['id'] == json.vehicle[i]['id']) {
								json.vehicle[i].lon_init = vehicles[j].lon_init;
								json.vehicle[i].lat_init = vehicles[j].lat_init;
								vehicles[j] = json.vehicle[i];
								isnew = false;
								break;
							} else {
								continue;
							}
						}
						// if no match, append the new vehicle
						if (isnew) {
							// save the initial lon,lat for later translations
							json.vehicle[i].lon_init = json.vehicle[i].lon;
							json.vehicle[i].lat_init = json.vehicle[i].lat;
							routes[agency_tag]['routes'][route_tag]['vehicles'].push(json.vehicle[i]);
						}
					}
				}

				//displayVehiclesForRoute(my_agency, route_tag);
			});
		}


		function displayVehiclesForRoute(agency_tag, route_tag) {

			//console.log("DISPLAY ROUTE", routes[agency_tag]['routes'][route_tag]);

			var vehicles = svg.selectAll(".route_" + route_tag)
				.data(routes[agency_tag]['routes'][route_tag]['vehicles']);

			vehicles
			    .transition()
			    .delay(1000)
			    /*
			    .attr("cx", function(d) {
		            return projection([d.lon, d.lat])[0];
		        })
		        .attr("cy", function(d) {
		            return projection([d.lon, d.lat])[1];
		        })*/
				.attr("transform", function(d) {

					console.log('new',  projection([d.lon, d.lat])[0]);

					console.log('init', d.lon_init, d.lat_init, projection([d.lon_init, d.lat_init])[0]);

					var t = "translate(" + (projection([d.lon, d.lat])[0] - projection([d.lon_init, d.lat_init])[0]) + "," + (projection([d.lon, d.lat])[1] - projection([d.lon_init, d.lat_init])[1]) + ")";

					console.log("TRANSFORM", t)
					return t;
				});

		    // add any new vehicles
			vehicles.enter()
				.append('g')
				  	.attr("class", function(d) {
						return "route_" + route_tag;
				  	})
				  	.attr("id", function(d) {
						return "vehicle_" + d.id;
					})
				  	.attr("visibility", function(){
				  		if (routes[agency_tag]['routes'][route_tag]['poll']) {
				  			return "visible";
				  		} else {
				  			return "hidden";
				  		}
				  	})
			  	.append("circle")
			    	.attr("cx", function(d) {
			            return projection([d.lon, d.lat])[0];
			        })
			        .attr("cy", function(d) {
			            return projection([d.lon, d.lat])[1];
			        })
			    	.attr("r", 2)
			    	.attr("fill", "#" + routes[agency_tag]['routes'][route_tag]['color']);

			vehicles.exit().remove();
		    	//.attr("fill-opacity", ".7");
		}



	});
</script>
</head>
<body>
	<div id="map"></div>

</body>
</html>